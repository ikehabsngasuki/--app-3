import os
from flask import Flask, send_file, render_template, request, redirect, url_for, flash
import pandas as pd
from reportlab.platypus import SimpleDocTemplate, Paragraph, Flowable, Table, TableStyle
from reportlab.lib.styles import getSampleStyleSheet, ParagraphStyle
from reportlab.lib import colors
from reportlab.lib.pagesizes import A4
from reportlab.pdfbase import pdfmetrics
from reportlab.pdfbase.ttfonts import TTFont
import io

# Flask アプリ設定
BASE_DIR = os.path.dirname(os.path.abspath(__file__))
TEMPLATE_DIR = os.path.join(BASE_DIR, "templates")
UPLOAD_FOLDER = os.path.join(BASE_DIR, "uploads")
os.makedirs(UPLOAD_FOLDER, exist_ok=True)

app = Flask(__name__, template_folder=TEMPLATE_DIR)
app.secret_key = "supersecretkey"
app.config["UPLOAD_FOLDER"] = UPLOAD_FOLDER

# フォント登録（Render上ではYuGothicが使えないため、代替フォントを設定）
# ローカルではYuGothicを使いたい場合はtry-exceptで切り替え
# フォント登録（Render上ではYuGothicが使えないため、代替フォントを設定）
try:
    pdfmetrics.registerFont(TTFont("YuGothic", "/mnt/c/Windows/Fonts/YuGothM.ttc"))
    FONT_NAME = "YuGothic"
except Exception:
    # RenderなどLinux環境では Helvetica を使用
    FONT_NAME = "Helvetica"


# スタイル修正
styles = getSampleStyleSheet()
styles.add(ParagraphStyle(name="YuGothicQ", parent=styles["Normal"],
                          fontName=FONT_NAME, fontSize=13, leading=14))
styles.add(ParagraphStyle(name="YuGothicA", parent=styles["Normal"],
                          fontName=FONT_NAME, fontSize=10, leading=12, textColor=colors.red))



# 番号枠
class NumberBox(Flowable):
    def __init__(self, number, width=40, height=40, radius=6):
        Flowable.__init__(self)
        self.number = number
        self.width = width
        self.height = height
        self.radius = radius

    def draw(self):
        self.canv.setStrokeColor(colors.blue)
        self.canv.setLineWidth(0.5)
        self.canv.roundRect(0, 0, self.width, self.height, self.radius, stroke=1, fill=0)
        self.canv.setFont(FONT_NAME, 10)
        self.canv.drawCentredString(self.width/2, self.height/2 - 4, str(self.number))


# 問題枠
class RoundedBox(Flowable):
    def __init__(self, text, width=100, height=40, radius=6, padding=4):
        Flowable.__init__(self)
        self.text = text
        self.width = width
        self.height = height
        self.radius = radius
        self.padding = padding

    def draw(self):
        self.canv.setStrokeColor(colors.blue)
        self.canv.setLineWidth(0.5)
        self.canv.roundRect(0, 0, self.width, self.height, self.radius, stroke=1, fill=0)
        p = Paragraph(self.text, styles["YuGothicQ"])
        w, h = p.wrap(self.width - 2*self.padding, self.height - 2*self.padding)
        x = self.padding
        y = (self.height - h) / 2
        p.drawOn(self.canv, x, y)


# 解答枠
class AnswerBox(Flowable):
    def __init__(self, width=100, height=40, radius=6, answer=None):
        Flowable.__init__(self)
        self.width = width
        self.height = height
        self.radius = radius
        self.answer = answer

    def draw(self):
        self.canv.setStrokeColor(colors.blue)
        self.canv.setLineWidth(0.5)
        self.canv.roundRect(0, 0, self.width, self.height, self.radius, stroke=1, fill=0)
        if self.answer:
            p = Paragraph(self.answer, styles["YuGothicA"])
            w, h = p.wrap(self.width - 8, self.height - 8)
            x = 4
            y = (self.height - h) / 2
            p.drawOn(self.canv, x, y)


# PDF作成
def build_pdf(df, with_answers=False):
    buffer = io.BytesIO()
    doc = SimpleDocTemplate(buffer, pagesize=A4,
                            leftMargin=20, rightMargin=20,
                            topMargin=20, bottomMargin=20)
    story = []

    PAGE_WIDTH, PAGE_HEIGHT = A4
    usable_width = PAGE_WIDTH - doc.leftMargin - doc.rightMargin
    gap = 12
    num_width = 40
    remaining_width = usable_width - num_width*2 - gap*5
    q_width = remaining_width * 0.5 / 2
    a_width = remaining_width * 0.5 / 2
    colWidths = [num_width, gap, q_width, gap, a_width,
                 gap, num_width, gap, q_width, gap, a_width]

    data, row, number = [], [], 1
    for i, rowdata in df.iterrows():
        q_text = f"{rowdata['word']}"
        ans_text = str(rowdata["meaning"]) if with_answers else None
        if (i % 2 == 0):
            row.extend([NumberBox(number, width=num_width, height=40), "",
                        RoundedBox(q_text, width=q_width, height=40), "",
                        AnswerBox(width=a_width, height=40, answer=ans_text)])
            number += 1
        else:
            row.extend(["", NumberBox(number, width=num_width, height=40), "",
                        RoundedBox(q_text, width=q_width, height=40), "",
                        AnswerBox(width=a_width, height=40, answer=ans_text)])
            number += 1
            data.append(row)
            row = []
    if row:
        while len(row) < len(colWidths):
            row.append("")
        data.append(row)

    table = Table(data, colWidths=colWidths, hAlign="CENTER", spaceBefore=6, spaceAfter=6)
    table.setStyle(TableStyle([
        ("VALIGN", (0, 0), (-1, -1), "MIDDLE"),
        ("LEFTPADDING", (0, 0), (-1, -1), 0),
        ("RIGHTPADDING", (0, 0), (-1, -1), 0),
        ("TOPPADDING", (0, 0), (-1, -1), 0),
        ("BOTTOMPADDING", (0, 0), (-1, -1), 0),
    ]))
    story.append(table)
    doc.build(story)
    buffer.seek(0)
    return buffer


# トップページ
@app.route("/")
def index():
    return render_template("test_index.html")


@app.route("/download_file/<filename>")
def download_file(filename):
    filepath = os.path.join(app.config["UPLOAD_FOLDER"], filename)
    if os.path.exists(filepath):
        return send_file(filepath, as_attachment=True)
    else:
        flash("指定されたファイルが存在しません")
        return redirect(url_for("download"))


# アップロードページ
@app.route("/upload", methods=["GET", "POST"])
def upload():
    if request.method == "POST":
        if "file" not in request.files:
            flash("ファイルが選択されていません")
            return redirect(request.url)
        file = request.files["file"]
        if file.filename == "":
            flash("ファイル名が空です")
            return redirect(request.url)
        if file and file.filename.endswith(".xlsx"):
            filepath = os.path.join(app.config["UPLOAD_FOLDER"], file.filename)
            file.save(filepath)
            flash("ファイルをアップロードしました！")
            return redirect(url_for("upload"))
        else:
            flash("xlsxファイルのみアップロード可能です")
            return redirect(request.url)

    files = [f for f in os.listdir(app.config["UPLOAD_FOLDER"]) if f.endswith(".xlsx")]
    files.sort(key=lambda x: os.path.getctime(os.path.join(app.config["UPLOAD_FOLDER"], x)), reverse=True)
    return render_template("test_upload.html", files=files)


# 問題作成ページ
@app.route("/make", methods=["GET", "POST"])
def make():
    files = [f for f in os.listdir(app.config["UPLOAD_FOLDER"]) if f.endswith(".xlsx")]
    files.sort(key=lambda x: os.path.getctime(os.path.join(app.config["UPLOAD_FOLDER"], x)), reverse=True)

    if request.method == "POST":
        filename = request.form.get("filename")
        start_num = int(request.form.get("start_num"))
        end_num = int(request.form.get("end_num"))
        num_questions = int(request.form.get("num_questions"))

        filepath = os.path.join(app.config["UPLOAD_FOLDER"], filename)
        df = pd.read_excel(filepath, engine="openpyxl")

        # number列を安全に処理
        df["number"] = pd.to_numeric(df["number"], errors="coerce")
        df = df.dropna(subset=["number"])
        df["number"] = df["number"].astype(int)

        # 範囲でフィルタリング
        df_range = df[(df["number"] >= start_num) & (df["number"] <= end_num)]

        # サンプリング
        num_questions = min(num_questions, len(df_range))
        sample = df_range.sample(n=num_questions).reset_index(drop=True)

        # 問題PDF
        buffer_q = build_pdf(sample, with_answers=False)
        q_path = os.path.join(app.config["UPLOAD_FOLDER"], "questions.pdf")
        with open(q_path, "wb") as f:
            f.write(buffer_q.read())

        # 解答PDF
        buffer_a = build_pdf(sample, with_answers=True)
        a_path = os.path.join(app.config["UPLOAD_FOLDER"], "answers.pdf")
        with open(a_path, "wb") as f:
            f.write(buffer_a.read())

        flash("問題と解答PDFを作成しました！")
        return redirect(url_for("download"))

    return render_template("test_makeq.html", files=files)


# ダウンロードページ
@app.route("/download")
def download():
    return render_template("test_d.html")


if __name__ == "__main__":
    app.run(debug=True)
