{% extends "base.html" %}
{% block title %}問題作成 | 英単語テストPDF{% endblock %}
{% block content %}

<div class="card" style="display:grid; gap:16px;">
  <h2>問題作成</h2>
  <p class="label-desc">
    出題元を選び、出題数などを指定してPDFを生成します。ヘッダーは
    <strong>number / word / meaning</strong> が必要です（順不同でOK）。
  </p>

  {% set selected_mode = request.form.get('select_mode', 'single') %}
  {% set selected_radio_mode = request.form.get('mode', 'en-ja') %}

  {# ★ lessons配下のベース名を収集（例: "lesson1.xlsx"） #}
  {% set ns = namespace(lesson_basenames=[]) %}
  {% for _folder, lfiles in lesson_tree.items() %}
    {% for rel in lfiles %}
      {% set _ = ns.lesson_basenames.append(rel.split('/')[-1]) %}
    {% endfor %}
  {% endfor %}

  <form action="{{ url_for('make') }}" method="post" class="stack" id="makeForm">
    <!-- 出題元の選択 -->
    <div class="field">
      <label>出題元</label>
      <div>
        <label>
          <input type="radio" name="select_mode" value="single"
                 {% if selected_mode == 'single' %}checked{% endif %}>
          単語帳（単一ファイル）
        </label>
        <label style="margin-left:12px;">
          <input type="radio" name="select_mode" value="lessons"
                 {% if selected_mode == 'lessons' %}checked{% endif %}>
          レッスン（フォルダ内の複数ファイル）
        </label>
      </div>
    </div>

    <!-- 単語帳（単一ファイル）ブロック：lessons配下は除外 -->
    <fieldset class="mode-block" id="block-single" data-mode="single">
      <legend>単語帳（単一ファイル）</legend>
      <div class="field">
        <label for="filename">ファイル</label>
        <select id="filename" name="filename" class="input">
          {% for f in files %}
            {% if f not in ns.lesson_basenames %}
              <option value="{{ f }}" {% if request.form.get('filename') == f %}selected{% endif %}>{{ f }}</option>
            {% endif %}
          {% endfor %}
        </select>
        {% if not files %}
          <p class="label-desc" style="margin-top:6px;">
            ファイルがありません。先に <a href="{{ url_for('upload') }}">アップロード</a> してください。
          </p>
        {% endif %}
      </div>

      <div class="twocol">
        <div class="field">
          <label for="start_num">開始番号</label>
          <input id="start_num" class="input" type="number" name="start_num"
                 min="1" placeholder="例: 1" value="{{ request.form.get('start_num','') }}">
        </div>
        <div class="field">
          <label for="end_num">終了番号</label>
          <input id="end_num" class="input" type="number" name="end_num"
                 min="1" placeholder="例: 100" value="{{ request.form.get('end_num','') }}">
        </div>
      </div>
      <p class="label-desc">※この範囲内からランダム抽出されます。</p>
    </fieldset>

    <!-- レッスン（複数ファイル）ブロック（従来どおり） -->
    <fieldset class="mode-block" id="block-lessons" data-mode="lessons">
      <legend>レッスン（フォルダ内の複数ファイル）</legend>

      <div class="field">
        <label for="lesson_folder">フォルダ</label>
        <select id="lesson_folder" name="lesson_folder" class="input">
          {% for folder, files_in in lesson_tree.items() %}
            <option value="{{ folder }}" {% if request.form.get('lesson_folder','') == folder %}selected{% endif %}>
              {{ folder if folder else '（直下）' }}
            </option>
          {% endfor %}
        </select>
        <p class="label-desc" style="margin-top:6px;">フォルダを選ぶと、その中の .xlsx を下で選択できます。</p>
      </div>

      <div class="field">
        <label for="lesson_files">ファイル（複数選択可）</label>
        <select id="lesson_files" name="lesson_files" class="input" multiple size="8">
          {% set current_folder = request.form.get('lesson_folder','') %}
          {% for rel in lesson_tree.get(current_folder, []) %}
            <option value="{{ rel }}"
              {% if rel in request.form.getlist('lesson_files') %}selected{% endif %}>
              {{ rel.split('/')[-1] }}
            </option>
          {% endfor %}
        </select>
        <p class="label-desc" style="margin-top:6px;">
          レッスン複数選択モードでは番号範囲の指定は不要です。選択したファイル群の中からランダム抽出します。
        </p>
      </div>
    </fieldset>

    <!-- 共通：出題モード / 出題数 -->
    <div class="field">
      <label>出題モード</label>
      <div>
        <label>
          <input type="radio" name="mode" value="en-ja"
                 {% if selected_radio_mode == 'en-ja' %}checked{% endif %}>
          英 → 和（英和）
        </label>
        <label style="margin-left:12px;">
          <input type="radio" name="mode" value="ja-en"
                 {% if selected_radio_mode == 'ja-en' %}checked{% endif %}>
          和 → 英（和英）
        </label>
      </div>
      <p class="label-desc" style="margin-top:6px;">
        英和：問題に <code>word</code>、解答に <code>meaning</code> を表示。<br>
        和英：問題に <code>meaning</code>、解答に <code>word</code> を表示。
      </p>
    </div>

    <div class="field">
      <label for="num_questions">出題数</label>
      <input id="num_questions" class="input" type="number" name="num_questions" min="1"
             placeholder="例: 20" value="{{ request.form.get('num_questions','') }}" required>
      <p class="label-desc" style="margin-top:6px;">
        ・単語帳モード：指定した番号範囲から抽出します。<br>
        ・レッスンモード：選択した複数ファイルを合算し、その中から抽出します。
      </p>
    </div>

    <div>
      <button type="submit" class="btn btn-primary" {% if not files and not lesson_tree %}disabled{% endif %}>
        PDFを作成
      </button>
      <a class="btn btn-outline" href="{{ url_for('download') }}" style="margin-left:6px;">ダウンロードへ</a>
    </div>
  </form>
</div>

<style>
  .twocol{ display:grid; grid-template-columns: 1fr 1fr; gap:12px; }
  @media (max-width:640px){ .twocol{ grid-template-columns: 1fr; } }
  .mode-block{ border:1px solid var(--line); border-radius:10px; padding:12px; }
  .mode-block[hidden]{ display:none !important; }
</style>

{# JSON埋め込み（既存のJS用）。ここは前回のまま #}
<script type="application/json" id="lessonTreeData">
{{ lesson_tree | tojson | safe }}
</script>

<script>
(function(){
  var form      = document.getElementById('makeForm');
  var blocks    = Array.prototype.slice.call(document.querySelectorAll('.mode-block'));
  var radioMode = form.querySelectorAll('input[name="select_mode"]');
  var folderSel = document.getElementById('lesson_folder');
  var filesSel  = document.getElementById('lesson_files');

  var treeJsonEl = document.getElementById('lessonTreeData');
  var tree = {};
  try { tree = JSON.parse((treeJsonEl && treeJsonEl.textContent) || '{}'); } catch (e) { tree = {}; }

  function getCheckedValue(name){
    var nodes = form.querySelectorAll('input[name="'+name+'"]');
    for (var i = 0; i < nodes.length; i++){ if (nodes[i].checked) return nodes[i].value; }
    return null;
  }

  function toggleBlocks(){
    var mode = getCheckedValue('select_mode') || 'single';
    for (var i = 0; i < blocks.length; i++){
      var b = blocks[i];
      var show = (b.getAttribute('data-mode') === mode);
      if (show){ b.removeAttribute('hidden'); } else { b.setAttribute('hidden', 'hidden'); }
      var inputs = b.querySelectorAll('input, select, textarea');
      for (var j = 0; j < inputs.length; j++){ inputs[j].disabled = !show; }
    }
  }

  // 初期化
  toggleBlocks();
  for (var i = 0; i < radioMode.length; i++){ radioMode[i].addEventListener('change', toggleBlocks); }

  function lastSegment(rel){
    var idx = rel.lastIndexOf('/');
    return (idx >= 0) ? rel.slice(idx + 1) : rel;
  }

  function rebuildFiles(){
    if (!folderSel || !filesSel) return;
    var folder  = folderSel.value || "";
    var options = tree[folder] || [];
    var selected = {};
    for (var i = 0; i < filesSel.options.length; i++){
      var op = filesSel.options[i];
      if (op.selected) selected[op.value] = true;
    }
    filesSel.innerHTML = "";
    for (var k = 0; k < options.length; k++){
      var rel = options[k];
      var opt = document.createElement('option');
      opt.value = rel;
      opt.textContent = lastSegment(rel);
      if (selected[rel]) opt.selected = true;
      filesSel.appendChild(opt);
    }
  }

  if (folderSel){ folderSel.addEventListener('change', rebuildFiles); }
})();
</script>

{% endblock %}
