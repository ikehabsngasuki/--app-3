{% extends "base.html" %}
{% block title %}問題作成 | 英単語テストPDF{% endblock %}
{% block content %}

<div class="card" style="display:grid; gap:16px;">
  <h2>問題作成</h2>
  <p class="label-desc">
    単一ファイル または レッスン（ZIP展開済み）から PDF を生成します。<br>
    ヘッダーは <strong>number / word / meaning</strong> が必要です（順不同でOK）。
  </p>

  {% set selected_mode = request.form.get('mode', 'en-ja') %}
  {% set select_mode   = request.form.get('select_mode', 'single') %}
  {% set picked_folder = request.form.get('lesson_folder', '') %}
  {% set picked_files  = request.form.getlist('lesson_files') %}

  <form action="{{ url_for('make') }}" method="post" class="stack">

    <!-- 出題元の選択方法 -->
    <div class="field">
      <label>出題元の選択方法</label>
      <div>
        <label>
          <input type="radio" name="select_mode" value="single"
                 {% if select_mode == 'single' %}checked{% endif %}>
          単語帳から作成
        </label>
        <label style="margin-left:12px;">
          <input type="radio" name="select_mode" value="lessons"
                 {% if select_mode == 'lessons' %}checked{% endif %}>
          教科書準拠テキストから作成
        </label>
      </div>
    </div>

    <!-- 単一ファイル -->
    <div class="field js-single">
      <label for="filename">単語帳を選択</label>
      <select id="filename" name="filename" class="input" {% if not files %}disabled{% endif %}>
        {% for f in files %}
          <option value="{{ f }}" {% if request.form.get('filename') == f %}selected{% endif %}>
            {{ f }}
          </option>
        {% endfor %}
      </select>
      {% if not files %}
        <p class="label-desc" style="margin-top:6px;">
          まだファイルがありません。先に <a href="{{ url_for('upload') }}">アップロード</a> してください。
        </p>
      {% endif %}
    </div>

    <!-- レッスン：フォルダ→ファイル複数選択 -->
    <div class="field js-lessons" hidden>
      <label for="lesson_folder">学年を選択</label>
      <select id="lesson_folder" name="lesson_folder" class="input" {% if not lesson_tree %}disabled{% endif %}>
        {% for folder, rels in lesson_tree.items() %}
          <option value="{{ folder }}" {% if picked_folder == folder %}selected{% endif %}>
            {{ folder if folder else '（直下）' }}
          </option>
        {% endfor %}
      </select>
      {% if not lesson_tree %}
        <p class="label-desc" style="margin-top:6px;">レッスンファイルがありません。<a href="{{ url_for('upload') }}">アップロード</a>へ。</p>
      {% endif %}

      <div style="margin-top:10px;">
        <label for="lesson_files">レッスンを選択（複数選択可）</label>
        <select id="lesson_files" name="lesson_files" class="input" multiple size="10" {% if not lesson_tree %}disabled{% endif %}>
          {# すべてのファイルを data-folder 属性付きで並べ、JSで絞り込み #}
          {% for folder, rels in lesson_tree.items() %}
            {% for rel in rels %}
              <option value="{{ rel }}"
                      data-folder="{{ folder }}"
                      {% if rel in picked_files %}selected{% endif %}>
                {{ rel.split('/')[-1] }}
              </option>
            {% endfor %}
          {% endfor %}
        </select>
        <p class="label-desc" style="margin-top:6px;">
          Ctrl/Cmd で複数選択。選択肢は上のフォルダに連動します。
        </p>
      </div>
    </div>

    <!-- 出題モード -->
    <div class="field">
      <label>出題モード</label>
      <div>
        <label>
          <input type="radio" name="mode" value="en-ja"
                 {% if selected_mode == 'en-ja' %}checked{% endif %}>
          英 → 和（英和）
        </label>
        <label style="margin-left:12px;">
          <input type="radio" name="mode" value="ja-en"
                 {% if selected_mode == 'ja-en' %}checked{% endif %}>
          和 → 英（和英）
        </label>
      </div>
    </div>

    <!-- 単一ファイル時：番号範囲 -->
    <div class="field js-range">
      <label for="start_num">開始番号</label>
      <input id="start_num" class="input" type="number" name="start_num" min="1"
             placeholder="例: 1" value="{{ request.form.get('start_num', '') }}" />
    </div>

    <div class="field js-range">
      <label for="end_num">終了番号</label>
      <input id="end_num" class="input" type="number" name="end_num" min="1"
             placeholder="例: 100" value="{{ request.form.get('end_num', '') }}" />
      <p class="label-desc" style="margin-top:6px;">
        ※ レッスン複数選択モードでは番号範囲は無視されます（全件プールからランダム抽出）。
      </p>
    </div>

    <!-- 出題数（全モードで必須） -->
    <div class="field">
      <label for="num_questions">出題数</label>
      <input id="num_questions" class="input" type="number" name="num_questions" min="1"
             placeholder="例: 20" value="{{ request.form.get('num_questions', '') }}" required />
      <p class="label-desc" style="margin-top:6px;">
        レッスン複数選択モード：選ばれたファイル全体からランダムに抽出します。<br>
        単一ファイルモード：番号範囲で絞り込んだ中からランダムに抽出します。
      </p>
    </div>

    <div>
      <button type="submit" class="btn btn-primary">PDFを作成</button>
      <a class="btn btn-outline" href="{{ url_for('download') }}" style="margin-left:6px;">ダウンロードへ</a>
    </div>
  </form>
</div>

<script>
  // 単一/レッスンの表示切替 & フォルダに応じてファイルを絞り込み
  (function () {
    const singleWrap  = document.querySelector('.js-single');
    const lessonsWrap = document.querySelector('.js-lessons');
    const rangeWraps  = document.querySelectorAll('.js-range');
    const radios      = document.querySelectorAll('input[name="select_mode"]');
    const filenameSel = document.getElementById('filename');
    const folderSel   = document.getElementById('lesson_folder');
    const filesSel    = document.getElementById('lesson_files');

    // すべての <option> をキャッシュ（data-folder 付き）
    const allFileOptions = filesSel ? Array.from(filesSel.options).map(opt => ({
      value: opt.value,
      text:  opt.text,
      folder: opt.getAttribute('data-folder') || '',
      selected: opt.selected
    })) : [];

    function updateMode() {
      const v = document.querySelector('input[name="select_mode"]:checked')?.value || 'single';
      const isSingle = (v === 'single');

      singleWrap.hidden  = !isSingle;
      lessonsWrap.hidden =  isSingle;

      if (filenameSel) filenameSel.disabled = !isSingle;
      if (folderSel)   folderSel.disabled   =  isSingle;
      if (filesSel)    filesSel.disabled    =  isSingle;

      // 番号範囲の表示/無効化
      rangeWraps.forEach(wrap => {
        wrap.hidden = !isSingle;
        const input = wrap.querySelector('input');
        if (input) input.disabled = !isSingle;
      });

      if (!isSingle) filterFiles(); // レッスンモードなら初回反映
    }

    function filterFiles() {
      if (!folderSel || !filesSel) return;
      const targetFolder = folderSel.value || "";

      // 現在の選択値を保存
      const prevSelected = new Set(Array.from(filesSel.selectedOptions).map(o => o.value));

      // 一旦空にして対象のみ追加
      filesSel.innerHTML = "";
      const subset = allFileOptions.filter(o => o.folder === targetFolder);

      subset.forEach(o => {
        const opt = document.createElement('option');
        opt.value = o.value;
        opt.textContent = o.text;
        opt.setAttribute('data-folder', o.folder);
        // 以前選択していたものは再選択
        if (prevSelected.has(o.value)) opt.selected = true;
        filesSel.appendChild(opt);
      });
    }

    radios.forEach(r => r.addEventListener('change', updateMode));
    if (folderSel) folderSel.addEventListener('change', filterFiles);

    // 初期状態の反映
    updateMode();
    // 直近のPOSTでフォルダが選ばれていた場合は、そのフォルダでフィルタ
    if (folderSel && filesSel && document.querySelector('input[name="select_mode"]:checked')?.value === 'lessons') {
      filterFiles();
    }
  })();
</script>

{% endblock %}
